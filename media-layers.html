<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
    <link rel="stylesheet" href="css/common.css">

    <title>Media Layers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"
      integrity="sha512-yNJzAsg5JyP91u+sLHlUDULMBd3hmEiVkYeeN1cQBKaLZ7EyT6oH2u5THNIRM2Fu6VKcZJv+F/QAp1h/qzy9Ow=="
      crossorigin="anonymous"></script>
  </head>
  <body>
    <header>
      <details open>
        <summary>Media Layers</summary>
        <p>
          Demonstrates using the Media Layers API to create a high-quality video player inside of an "immersive-vr" session.
          <a class="back" href="./">Back</a>
        </p>
        <!-- <label>Choose the media"s layout:</label>
        <select id="layoutselect">
          <option value="./media/video/60fps.mp4">
            mono
          </option>
          <option value="./media/video/bbb-sunflower-540p2-1min.webm">
            stereo-top-bottom
          </option>
        </select>
        <p>Trigger = Squeeze = play / pause the video</p> -->
      </details>
    </header>
    <main style="text-align: center;">
      <p>Click "Enter VR" to see content</p>
    </main>
    <script type="module">
      import { WebXRButton } from "./js/util/webxr-button.js";
      import { QueryArgs } from "./js/util/query-args.js";

      // If requested, use the polyfill to provide support for mobile devices
      // and devices which only support WebVR.
      import WebXRPolyfill from "./js/third-party/webxr-polyfill/build/webxr-polyfill.module.js";
      if (QueryArgs.getBool("usePolyfill", true)) {
        let polyfill = new WebXRPolyfill();
      }

      let xrButton = null;

      let refSpace = null;
      let session = null;

      let gl = null;
      let scene = null;
      let camera = null;
      let renderer = null;
      let cube = null;

      let framebuffer = null;
      let readFramebuffer = null;
      let helper = null;

      let projectionWebGlLayer = null;
      let xrWebGlBinding = null;

      function initXR() {
        xrButton = new WebXRButton({ onRequestSession, onEndSession });
        document.querySelector("header").appendChild(xrButton.domElement);

        if (navigator.xr) {
          navigator.xr.isSessionSupported("immersive-vr").then(supported => {
            xrButton.enabled = supported;
          });
        }
      }

      function onRequestSession() {
        navigator.xr.requestSession("immersive-vr", {
          requiredFeatures: ["layers", "local-floor"],
        }).then(session => {
          xrButton.setSession(session);
          initializeSession(session);
        });
      }

      async function initializeSession(session) {
        scene = new THREE.Scene();
        renderer = new THREE.WebGLRenderer({
          antialias: true,
          alpha: true
        });

        scene.matrixAutoUpdate = false;
        renderer.autoClear = false;

        if (gl) gl.canvas.remove();
        gl = renderer.getContext();

        renderer.xr.enabled = true;
        renderer.setSize(2432, 1344);
        renderer.setClearColor(0xffffff, 1);

        framebuffer = gl.createFramebuffer();
        readFramebuffer = gl.createFramebuffer();

        await gl.makeXRCompatible();
        startSession(session);
      }

      async function startSession(session) {
        document.body.appendChild(gl.canvas);
        session.requestReferenceSpace("local-floor")
          .then(referenceSpace => {
            refSpace = referenceSpace;
            xrWebGlBinding = new XRWebGLBinding(session, gl);
            projectionWebGlLayer = xrWebGlBinding.createProjectionLayer({});

            camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 2000);
            camera.position.z = 1000;
            scene.add(camera);

            helper = new THREE.CameraHelper(camera);
            helper.visible = true;
            scene.add(helper);

            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            cube = new THREE.Mesh(geometry, material);

            cube.scale.x = 50;
            cube.scale.y = 50;
            cube.scale.z = 50;
            scene.add(cube);

            const layers = [projectionWebGlLayer];
            session.updateRenderState({ layers });
            
            session.requestAnimationFrame(onAnimationFrame);            
          });
      }

      function onAnimationFrame(time, frame) {        
        const pose = frame.getViewerPose(refSpace);
        if (!pose) return;

        cube.rotation.x += 0.02;
				cube.rotation.y += 0.02;
        cube.rotation.z += 0.02;

        renderer.clear();
        gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);

        for (let view of pose.views) {
          const viewSubImage = xrWebGlBinding.getViewSubImage(projectionWebGlLayer, view);;
          let viewMatrix = new THREE.Matrix4();

          const viewport = viewSubImage.viewport;
          renderer.setViewport(viewport.x, viewport.y, viewport.width, viewport.height);

          viewMatrix.fromArray(pose.transform.matrix);
          camera.projectionMatrix.fromArray(view.projectionMatrix);

          scene.updateMatrixWorld(true);
          renderer.render(scene, camera);
          renderer.clearDepth();

          gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, viewSubImage.colorTexture, 0);
          gl.bindFramebuffer(gl.READ_FRAMEBUFFER, readFramebuffer);
        }

        renderer.render(scene, camera);
        frame.session.requestAnimationFrame(onAnimationFrame);
      }

      function onEndSession(session) {
        xrButton.setSession(null);
        session.end();
        renderer = null;
      }

      // Start the XR application.
      initXR();
    </script>
  </body>
</html>
